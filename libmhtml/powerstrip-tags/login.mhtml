;;; login.mhtml: -*- Meta-HTML -*-  Login initialization and form.
;;;
;;;  Copyright (c) 1996 Brian J. Fox
;;;  Author: Brian J. Fox (bfox@ai.mit.edu) Thu May  8 10:52:48 1997.

<defun login::initialize>
  ;;; DOC_SECTION (POWERSTRIP-SYSTEM-TAGS)
  ;;; Place before including the header, if, and only if, this page is to
  ;;; contain the login form generated by
  ;;; <example code><login::powerstrip-login></example>.
  ;;;
  <when <match <get-var env::http_user_agent>
	       "(Mozilla/[345]|MSIE/[345]|MSIE 3)">>
    <set-var default::javascript?=true>
    <set-var ibis::head-params = 
      "<script language=JavaScript>

    <!--
     function gotoUsername() { document.login.username.focus(); }
     function gotoPassword() { document.login.password.focus(); }
     function sendForm() { document.login.submit(); }
     // -->
    </script>
  ">
    <set-var onload="gotoUsername()">
    <set-var ibis::body-params = "onLoad=<get-var onload>">
  </when>
</defun>

<defun login::powerstrip-login continue-link>
  ;;; DOC_SECTION (POWERSTRIP-SYSTEM-TAGS)
  ;;; Login, or present a login form, which authenticates based on the
  ;;; PowerStrip database of users.
  <when <match "<package-vars posted>" "POSTED::USERNAME">>
    <when <and <get-var-once posted::username>
	       <not <string-eq <get-var-once posted::username> "TEMPLATE">>>>
      <subst-in-var posted::username "^[ \t]+" "" "[ \t\n]+$" "">
      <with-open-database db <site::user-db> mode=read>
	<set-var loaded? =
	  <database-load-record db <get-var-once posted::username>>>
      </with-open-database>
    </when>

    <if <and <get-var loaded?>
	     <string-eq
	      <encrypted-password <get-var-once posted::password>
				  <substring <get-var-once password> 0 2>>
	      <get-var-once password>>>
	<prog
	  <set-session-var
	    site::user-id=<get-var default::username>
	    site::user-real-name=<get-var user-real-name>
	    site::user-station=<get-var env::remote_host>
	    site::user-acl=<get-var acl>
	    site::e-mail=<get-var e-mail>>
	  <redirect <or <get-var continue-link>
			<get-var mhtml::url-to-dir>/welcome.mhtml>>>
      <prog
	<layout::page>
	<ptext>
	It appears that you did not enter your User ID or Password correctly.

	Please enter your User ID carefully and <i>exactly</i> as it was
	assigned to you.  Remember, case of characters is significant.
	Be just as careful when entering your password.

	If you haven't been given a password yet, please call or send E-mail
	to your supervisor.

	<when <get-var-once hint>>
	<center>
	<hr width=60% size=4>
	<b>Hint: <get-var-once hint>...</b>
	<hr width=60% size=4>
	</center>
	</when>

	</ptext>
	<hr>
	</layout::page>
	<p>>>
  </when>

  <unset-var SID>

  <layout::page>
    <ptext>
      You must login with your PowerStrip User ID and Password.<br>
      Please fill in the form below, and then click on <b>Login</b>.
    </ptext>

    <form name=login method=POST action="<thisdoc>">
      <center>
	<table width=350 bgcolor="#A080A0">
	  <tr>
	    <td align=left>
	      <font size=3 color="#000000"><b>User ID:</b></font><br>
	      <input type=text size=30 name=username
		     value="<get-var-once default::username>">
	    </td>
	  </tr>
	  <tr>
	    <td align=left>
	      <font size=3 color="#000000"><b>Password:</b></font><br>
	      <input type=password size=30 name=password value=""
		   <if <get-var default::javascript?> "onChange=sendForm()">>
	    </td>
	  </tr>
	</table>
	<p>
	<input type=submit name=action value=Login>
      </center>
    </form>
  </layout::page>
</defun>
